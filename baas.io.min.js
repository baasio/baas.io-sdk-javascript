// baas.io.js - v0.4.0
// https://baas.io
// JavaScript SDK for Hybrid Web Application based on baas.io
// (c) 2012-2013 KTH, support@kthcorp.com
(function(){function t(t){var e=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;return t?e.test(t):!1}function e(t){tail=[];var e=[];if(t instanceof Array)for(i in t)e=t[i],e instanceof Array&&e.length>1&&tail.push(e[0]+"="+encodeURIComponent(e[1]));else for(var o in t)if(t.hasOwnProperty(o)){var n=t[o];if(n instanceof Array)for(i in n)e=n[i],tail.push(o+"="+encodeURIComponent(e));else tail.push(o+"="+encodeURIComponent(n))}return tail.join("&")}var o=this,n=o.Baas||{};o.console=o.console||{},o.console.log=o.console.log||function(){},n.VERSION="0.4.0","undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=n),exports.Baas=n):o.Baas=n,n.IO=function(t){this.URI="https://api.baas.io",this.orgName=t.orgName,this.appName=t.appName,this.buildCurl=t.buildCurl||!1,this.logging=t.logging||!1,this._callTimeout=t.callTimeout||3e4,this._callTimeoutCallback=t.callTimeoutCallback||null,this.logoutCallback=t.logoutCallback||null},n.IO.prototype.request=function(t,o){var i=this,n=t.method||"GET",s=t.endpoint,r=t.body||{},l=t.qs||{},a=t.mQuery||!1;if(a)var c=this.URI+"/"+s;else var c=this.URI+"/"+this.orgName+"/"+this.appName+"/"+s;i.getToken()&&(l.access_token=i.getToken());var u=e(l);u&&(c+="?"+u),r=JSON.stringify(r);var f=new XMLHttpRequest;f.open(n,c,!0),r&&f.setRequestHeader("Content-Type","application/json"),f.onerror=function(){i._end=(new Date).getTime(),i.logging&&console.log("success (time: "+i.calcTimeDiff()+"): "+n+" "+c),i.logging&&console.log("Error: API call failed at the network level."),clearTimeout(h);var t=!0;"function"==typeof o&&o(t,data)},f.onload=function(t){if(i._end=(new Date).getTime(),i.logging&&console.log("success (time: "+i.calcTimeDiff()+"): "+n+" "+c),clearTimeout(h),t=JSON.parse(f.responseText),200!=f.status){var e=t.error,s=t.error_description;if(i.logging&&console.log("Error ("+f.status+")("+e+"): "+s),("auth_expired_session_token"==e||"unauthorized"==e||"auth_missing_credentials"==e||"auth_invalid"==e)&&"function"==typeof i.logoutCallback)return i.logoutCallback(!0,t);"function"==typeof o&&o(!0,t)}else"function"==typeof o&&o(!1,t)};var h=setTimeout(function(){f.abort(),"function"===i._callTimeoutCallback?i._callTimeoutCallback("API CALL TIMEOUT"):i.callback("API CALL TIMEOUT")},i._callTimeout);if(this.logging&&console.log("calling: "+n+" "+c),this.buildCurl){var p={uri:c,body:r,method:n};this.buildCurlCall(p)}this._start=(new Date).getTime(),f.send(r)},n.IO.prototype.createEntity=function(t,e){var t={client:this,data:t},o=new n.Entity(t);o.save(function(t){"function"==typeof e&&e(t,o)})},n.IO.prototype.createCollection=function(t,e){t.client=this;var o=new n.Collection(t,function(t){"function"==typeof e&&e(t,o)})},n.IO.prototype.createUserActivity=function(t,e,o){e.type="users/"+t+"/activities";var e={client:this,data:e},i=new n.Entity(e);i.save(function(t){"function"==typeof o&&o(t,i)})},n.IO.prototype.calcTimeDiff=function(){var t=0,e=this._end-this._start;try{t=(e/10/60).toFixed(2)}catch(o){return 0}return t},n.IO.prototype.setToken=function(t){this.token=t,"undefined"!=typeof Storage&&localStorage.setItem("token",t)},n.IO.prototype.getToken=function(){return this.token?this.token:"undefined"!=typeof Storage?localStorage.getItem("token"):null},n.IO.prototype.login=function(t,e,o){var i=this,s={method:"GET",endpoint:"token",qs:{username:t,password:e,grant_type:"password"}};this.request(s,function(t,e){var s={};t&&i.logging?console.log("error trying to log user in"):(s=new n.Entity("users",e.user),i.setToken(e.access_token)),"function"==typeof o&&o(t,e,s)})},n.IO.prototype.loginFacebook=function(t,e){var o=this,i={method:"GET",endpoint:"auth/facebook",qs:{fb_access_token:t}};this.request(i,function(t,i){var s={};t&&o.logging?console.log("error trying to log user in"):(s=new n.Entity("users",i.user),o.setToken(i.access_token)),"function"==typeof e&&e(t,i,s)})},n.IO.prototype.getLoggedInUser=function(t){if(this.getToken()){var e=this,o={method:"GET",endpoint:"users/me"};this.request(o,function(o,i){if(o)e.logging&&console.log("error trying to log user in"),"function"==typeof t&&t(o,i,null);else{var s={client:e,data:i.entities[0]},r=new n.Entity(s);"function"==typeof t&&t(o,i,r)}})}else t(!0,null,null)},n.IO.prototype.isLoggedIn=function(){return this.getToken()?!0:!1},n.IO.prototype.logout=function(){this.setToken(null)},n.IO.prototype.buildCurlCall=function(t){var e="curl",o=(t.method||"GET").toUpperCase(),i=t.body||{},n=t.uri;return e+="POST"===o?" -X POST":"PUT"===o?" -X PUT":"DELETE"===o?" -X DELETE":" -X GET",e+=" "+n,i=JSON.stringify(i),'"{}"'!==i&&"GET"!==o&&"DELETE"!==o&&(e+=" -d '"+i+"'"),console.log(e),e},n.Entity=function(t){this._client=t.client,this._data=t.data||{}},n.Entity.prototype.get=function(t){return t?this._data[t]:this._data},n.Entity.prototype.set=function(t,e){if("object"==typeof t)for(var o in t)this._data[o]=t[o];else"string"==typeof t?null===e?delete this._data[t]:this._data[t]=e:this._data=null},n.Entity.prototype.save=function(e){var o=this.get("type"),i="POST";t(this.get("uuid"))&&(i="PUT",o+="/"+this.get("uuid"));var n=this,s={},r=this.get();for(var l in r)"metadata"!==l&&"created"!==l&&"modified"!==l&&"type"!==l&&"activatted"!==l&&(s[l]=r[l]);var a={method:i,endpoint:o,body:s};this._client.request(a,function(t,i){if(t&&n._client.logging){if(console.log("could not save entity"),"function"==typeof e)return e(t,i,n)}else{if(i.entities.length){var s=i.entities[0];n.set(s)}var l="users"===o&&r.oldpassword&&r.newpassword;if(l){var a={};a.oldpassword=r.oldpassword,a.newpassword=r.newpassword,this._client.request({method:"PUT",endpoint:o,body:a},function(t,o){t&&n._client.logging&&console.log("could not update user"),n.set("oldpassword",null),n.set("newpassword",null),"function"==typeof e&&e(t,o,n)})}else"function"==typeof e&&e(t,i,n)}})},n.Entity.prototype.fetch=function(t){var e=this.get("type"),o=this;if(this.get("uuid"))e+="/"+this.get("uuid");else if("users"===e){if(this.get("username"))e+="/"+this.get("username");else if("function"==typeof t){var i="cannot fetch entity, no username specified";return o._client.logging&&console.log(i),t(!0,i,o)}}else if(this.get("name"))e+="/"+this.get("name");else if("function"==typeof t){var i="cannot fetch entity, no name specified";return o._client.logging&&console.log(i),t(!0,i,o)}var n={method:"GET",endpoint:e};this._client.request(n,function(e,i){if(e&&o._client.logging)console.log("could not get entity");else if(i.user)o.set(i.user);else if(i.entities.length){var n=i.entities[0];o.set(n)}"function"==typeof t&&t(e,i,o)})},n.Entity.prototype.destroy=function(e){var o=this.get("type");if(t(this.get("uuid")))o+="/"+this.get("uuid");else if("function"==typeof e){var i="Error trying to delete object - no uuid specified.";n._client.logging&&console.log(i),e(!0,i)}var n=this,s={method:"DELETE",endpoint:o};this._client.request(s,function(t,o){t&&n._client.logging?console.log("entity could not be deleted"):n.set(null),"function"==typeof e&&e(t,o)})},n.Collection=function(t,e){this._client=t.client,this._type=t.type,this.qs=t.qs||{},this._list=[],this._iterator=-1,this._previous=[],this._next=null,this._cursor=null,this.fetch(e)},n.Collection.prototype.fetch=function(t){var e=this,o=this.qs;this._cursor?o.cursor=this._cursor:delete o.cursor;var i={method:"GET",endpoint:this._type,qs:this.qs};this._client.request(i,function(o,i){if(o&&e._client.logging)console.log("error getting collection");else{var s=i.cursor||null;if(e.saveCursor(s),i.entities){e.resetEntityPointer();var r=i.entities.length;e._list=[];for(var l=0;r>l;l++){var a=i.entities[l].uuid;if(a){var c=i.entities[l]||{},u={type:e._type,client:e._client,uuid:a,data:c},f=new n.Entity(u),h=e._list.length;e._list[h]=f}}}}"function"==typeof t&&t(o,i)})},n.Collection.prototype.addEntity=function(t,e){var o=this;t.type=this._type,this._client.createEntity(t,function(t,i){if(!t){var n=o._list.length;o._list[n]=i}"function"==typeof e&&e(t,i)})},n.Collection.prototype.destroyEntity=function(t,e){var o=this;t.destroy(function(t,i){t?(o._client.logging&&console.log("could not destroy entity"),"function"==typeof e&&e(t,i)):o.fetch(e)})},n.Collection.prototype.getEntityByUUID=function(t,e){var o={data:{type:this._type,uuid:t},client:this._client},i=new n.Entity(o);i.fetch(e)},n.Collection.prototype.getFirstEntity=function(){var t=this._list.length;return t>0?this._list[0]:null},n.Collection.prototype.getLastEntity=function(){var t=this._list.length;return t>0?this._list[t-1]:null},n.Collection.prototype.hasNextEntity=function(){var t=this._iterator+1,e=t>=0&&this._list.length>t;return e?!0:!1},n.Collection.prototype.getNextEntity=function(){this._iterator++;var t=this._iterator>=0&&this._iterator<=this._list.length;return t?this._list[this._iterator]:!1},n.Collection.prototype.hasPrevEntity=function(){var t=this._iterator-1,e=t>=0&&this._list.length>t;return e?!0:!1},n.Collection.prototype.getPrevEntity=function(){this._iterator--;var t=this._iterator>=0&&this._iterator<=this._list.length;return t?this.list[this._iterator]:!1},n.Collection.prototype.resetEntityPointer=function(){this._iterator=-1},n.Collection.prototype.saveCursor=function(t){this._next!==t&&(this._next=t)},n.Collection.prototype.resetPaging=function(){this._previous=[],this._next=null,this._cursor=null},n.Collection.prototype.hasNextPage=function(){return this._next},n.Collection.prototype.getNextPage=function(t){this.hasNextPage()&&(this._previous.push(this._cursor),this._cursor=this._next,this._list=[],this.fetch(t))},n.Collection.prototype.hasPreviousPage=function(){return this._previous.length>0},n.Collection.prototype.getPreviousPage=function(t){this.hasPreviousPage()&&(this._next=null,this._cursor=this._previous.pop(),this._list=[],this.fetch(t))}})();